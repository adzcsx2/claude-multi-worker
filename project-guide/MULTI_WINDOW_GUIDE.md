# 多任务协同工作指南

> 使用多个 Claude CLI 窗口协同开发，避免上下文丢失

---

## 🎯 问题场景

单个 Claude 窗口处理所有任务时：
- ❌ 上下文过大，导致信息丢失
- ❌ 长对话后响应变慢
- ❌ 难以并行处理复杂任务

## 💡 解决方案：多窗口协同

```
┌─────────────────────────────────────────────────┐
│  窗口 1: 主任务 Claude        │  窗口 2: 测试 Claude  │
│  - 开发功能                │  - 运行测试          │
│  - 编写代码                │  - 检查质量          │
│  - 修复 Bug                │  - 性能分析          │
│  - 架构设计                │  - 文档生成          │
└─────────────────────────────────────────────────┘
```

---

## 🤖 全自动模式（推荐）

> **无需人工干预！三个窗口自动循环工作**

```
C1 (设计) → C2 (开发) → C3 (测试) → C1 (下一个界面) → ...
```

**特点：**
- ✅ 全自动循环，无需手动输入"继续"
- ✅ 支持中断恢复，关闭窗口后可自动继续
- ✅ 状态持久化，进度保存在 `task-comms/automation-state.md`

**快速启动：**
```bash
# 三个终端分别运行
C1: 我是 C1 窗口，设计任务。启动自动化模式。
C2: 我是 C2 窗口，主任务。启动自动化模式。
C3: 我是 C3 窗口，测试任务。启动自动化模式。
```

📖 **详细指南**: [AUTOMATION_GUIDE.md](AUTOMATION_GUIDE.md)

---

## 🎨 设计先行原则（Design First）

> **重要**: 开发前必须先完成设计！

```
设计窗口先行 → 主任务窗口基于设计开发 → 测试窗口测试
     ↓                    ↓                      ↓
创建设计系统         严格遵循设计规范          验证功能
统一所有界面         实现所有界面              发现问题
补充缺失设计
```

### 为什么设计先行？

| 不设计先行 | 设计先行 |
|----------|---------|
| ❌ UI 风格不一致 | ✅ 统一的设计系统 |
| ❌ AI 生成 UI 随意发挥 | ✅ 按规范实现 |
| ❌ 缺失页面随意设计 | ✅ 基于设计系统补充 |
| ❌ 后期频繁修改 | ✅ 一次做对 |

### 设计窗口产出的文档

1. **memory-bank/07-design-system.md** - 设计系统规范
   - 颜色、字体、组件、间距等所有规范
   - 所有界面必须遵循的唯一标准

2. **memory-bank/06-ui-design.md** - UI 设计文档
   - 所有界面的设计说明
   - HTML → Android/iOS/Web 实现要点

### 主任务窗口如何使用

```bash
# 开发前必须先读取这两个文档
1. Read: memory-bank/07-design-system.md
2. Read: memory-bank/06-ui-design.md

# 然后才能开始开发
3. 基于设计文档实现界面
```

---

## 📁 目录结构

```
project/
├── memory-bank/
│   ├── 00-task-queue.md       # 任务队列（协同核心）
│   ├── 01-tech-stack.md
│   ├── 02-product-requirements.md
│   ├── 03-implementation-plan.md
│   ├── 04-architecture.md
│   └── 05-progress.md
│
├── task-comms/                   # Claude 间通信目录
│   ├── from-main.md            # 主任务 → 其他
│   ├── from-test.md            # 测试 → 其他
│   └── shared-state.md         # 共享状态
│
└── .git/
```

---

## 🔄 工作流程

### 1. 任务队列系统

**`memory-bank/00-task-queue.md`**

```markdown
# 任务队列

## 待处理任务
- [ ] Task-001: 实现用户登录功能
- [ ] Task-002: 编写登录单元测试
- [ ] Task-003: UI模拟测试登录流程

## 进行中任务
- [x] Task-004: 设计数据库架构 (窗口: 主任务)

## 已完成任务
- [x] Task-000: 项目初始化 (窗口: 主任务)
```

### 2. 窗口角色定义（完整版）

| 窗口 | 角色 | 负责内容 | 必需性 |
|------|------|----------|----------|
| **Claude 1** | 主任务（开发） | 架构设计、功能开发、Bug 修复、代码重构 | ✅ 必需 |
| **Claude 2** | 测试任务（QA） | 单元测试、UI模拟测试、质量检查、回归测试 | ✅ 必需 |
| **Claude 3** | 设计任务（UI/UX） | UI 设计图分析、界面实现、用户体验优化 | ⚠️ 推荐 |
| **Claude 4** | 文档任务（技术写作） | API 文档、用户手册、README、CHANGELOG | ⚠️ 推荐 |
| **Claude 5** | 审查任务（Code Review） | 代码审查、安全审查、性能优化建议 | 🔄 可选 |

> 💡 **小团队模式**（2-3窗口）：
> - 窗口 1: 主任务 + 设计
> - 窗口 2: 测试任务 + 文档

---

### 3. 多窗口协作工作流（依赖关系）

#### 📋 完整工作流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        项目启动阶段                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  窗口 1 (主任务)                                                         │
│  ├── 创建项目结构                                                       │
│  ├── 初始化 memory-bank/ 文档 (01-05)                                  │
│  └── 通知设计窗口开始设计                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                    设计阶段 (设计窗口先行!)                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  窗口 3 (设计任务)  ←───  ⚠️ 必须在开发前完成!                          │
│  ├── 📋 分析 /ui/* 中的所有 AI 生成的 UI 设计图                         │
│  ├── 🎨 创建 memory-bank/07-design-system.md (设计系统)                 │
│  │   ├── 颜色系统（主色、辅色、中性色、语义色）                         │
│  │   ├── 字体系统（字体家族、字号规范）                                 │
│  │   ├── 组件规范（按钮、输入框、卡片、导航栏）                         │
│  │   ├── 间距系统、图标系统、圆角阴影                                   │
│  │   └── 布局规范、动画规范                                             │
│  ├── 📱 创建 memory-bank/06-ui-design.md (UI 设计文档)                  │
│  │   ├── 所有界面清单                                                  │
│  │   ├── 每个/界面的布局说明                                           │
│  │   └── HTML → Android/iOS/Web 实现要点                               │
│  ├── 🔄 处理 AI 生成 UI 不一致问题                                      │
│  │   └── 以 07-design-system.md 为准统一所有界面                       │
│  └── 📤 通知主任务窗口：设计完成，可以开始开发                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                      开发阶段 (基于设计文档)                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  窗口 1 (主任务)  ←───  ✅ 基于设计文档开发                              │
│  ├── 📖 先读取设计文档：                                               │
│  │   ├── memory-bank/07-design-system.md (设计系统)                    │
│  │   ├── memory-bank/06-ui-design.md (UI 设计)                        │
│  │   ├── memory-bank/02-product-requirements.md (产品需求)            │
│  │   └── memory-bank/04-architecture.md (架构)                         │
│  ├── 💻 实现功能代码：                                                 │
│  │   ├── 严格按照 07-design-system.md 的设计规范实现 UI                │
│  │   ├── 根据 06-ui-design.md 的界面清单逐个实现                        │
│  │   └── 后端逻辑、数据模型等                                          │
│  └── 📤 完成后通知测试窗口：功能已开发，请测试                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                        测试阶段                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  窗口 2 (测试任务)                                                      │
│  ├── 📖 读取功能代码和设计文档                                          │
│  ├── ✍️ 编写单元测试                                                   │
│  ├── 🤖 编写 UI 模拟测试（adb 控制模拟器）                              │
│  ├── ▶️ 运行测试并生成报告                                              │
│  └── 📤 将测试结果反馈给主任务窗口                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### ⚠️ 关键依赖关系

| 阶段 | 前置条件 | 负责窗口 | 产出文档 | 下游依赖 |
|-----|---------|---------|---------|---------|
| **设计阶段** | 项目初始化完成 | 窗口 3 (设计) | 07-design-system.md<br>06-ui-design.md | → 主任务窗口 |
| **开发阶段** | 设计文档完成 | 窗口 1 (主任务) | 功能代码<br>04-architecture.md | → 测试窗口 |
| **测试阶段** | 功能代码完成 | 窗口 2 (测试) | 测试报告<br>测试代码 | → 主任务窗口 |
| **文档阶段** | 功能稳定 | 窗口 4 (文档) | API 文档<br>用户手册 | - |

#### 📝 设计窗口 → 主任务窗口 通信示例

**设计窗口发送任务完成通知：**

```markdown
<!-- task-comms/from-design.md -->

## 设计完成通知

**任务 ID**: Design-001
**状态**: ✅ 已完成
**完成时间**: {时间}

### 已创建的设计文档

1. **memory-bank/07-design-system.md** - 设计系统
   - ✅ 颜色系统定义完成
   - ✅ 字体系统定义完成
   - ✅ 组件规范定义完成（按钮、输入框、卡片、导航栏）
   - ✅ 间距、图标、圆角、阴影规范完成

2. **memory-bank/06-ui-design.md** - UI 设计文档
   - ✅ 已分析 /ui/* 中的所有设计图
   - ✅ 已统一所有界面到设计系统规范
   - ✅ 已补充缺失界面的设计
   - ✅ 已生成 HTML → Android 实现要点

### 界面清单

| 界面名称 | 设计状态 | 可以开发 |
|---------|---------|---------|
| 登录页面 | ✅ 已设计 | ✅ 是 |
| 主页 | ✅ 已设计 | ✅ 是 |
| 个人中心 | ✅ 已设计 | ✅ 是 |
| 设置页面 | ✅ 已设计 | ✅ 是 |

### 下一步

主任务窗口可以开始基于这些设计文档进行开发。
所有 UI 实现必须严格遵循 07-design-system.md 的规范。
```

#### 🎯 主任务窗口接收设计后的操作

**主任务窗口读取设计完成通知后：**

```bash
# 1. 读取设计文档
Read: memory-bank/07-design-system.md
Read: memory-bank/06-ui-design.md

# 2. 确认可以开始开发
# 向设计窗口确认设计已完成

# 3. 开始第一个界面的开发
# 选择 06-ui-design.md 中的第一个界面开始实现
```

#### 🔁 开发-测试循环

```
主任务窗口完成一个界面
        ↓
    通知测试窗口
        ↓
    测试窗口编写测试并运行
        ↓
    测试通过 → 通知主任务继续下一个界面
    测试失败 → 反馈问题给主任务修复
        ↓
    主任务修复问题后重新通知测试
```

---

### 角色详细说明

#### 🔵 窗口 1：主任务（开发）
```
职责：
✅ 架构设计和技术选型
✅ 功能开发（后端/前端/移动端）- 基于设计文档实现
✅ Bug 修复和调试
✅ 代码重构和优化
✅ 性能优化
✅ 安全性增强

⚠️ 前置条件：
- 必须等待设计窗口完成 07-design-system.md 和 06-ui-design.md
- UI 开发必须严格遵循设计系统规范

输入：
- memory-bank/07-design-system.md（设计系统） ← 必须先读这个!
- memory-bank/06-ui-design.md（UI 设计文档） ← 然后读这个!
- memory-bank/02-product-requirements.md（产品需求）
- memory-bank/04-architecture.md（架构）
- task-comms/from-design.md（设计任务完成通知）
- task-comms/from-review.md（审查反馈）

输出：
- 功能代码（严格遵循 07-design-system.md）
- 更新 memory-bank/04-architecture.md
- 任务完成通知到测试窗口

工作流程：
1. 等待设计窗口发送完成通知（from-design.md）
2. 读取 07-design-system.md 了解设计规范
3. 读取 06-ui-design.md 了解界面清单
4. 选择第一个界面开始实现
5. 完成后通知测试窗口
```

#### 🟢 窗口 2：测试任务（QA）
```
职责：
✅ 单元测试编写和执行
✅ UI 模拟测试（adb 控制模拟器）
✅ 集成测试
✅ 回归测试
✅ 测试报告生成
✅ Bug 验证

⚠️ 重要：所有测试文件必须保存到 test/ 目录下
- 截图 → test/screenshots/
- 报告 → test/reports/
- 日志 → test/logs/
- 脚本 → test/scripts/
- 临时文件 → test/temp/

输入：
- 主任务窗口的功能代码
- memory-bank/02-product-requirements.md
- task-comms/from-main.md（任务分配）

输出：
- 测试代码
- 测试报告（test/reports/unit/, test/reports/ui-simulation/）
- 截图（test/screenshots/ui-simulation/）
- 测试日志（test/logs/ui-simulation/）
- 测试结果反馈到 task-comms/from-test.md

工作流程：
1. 创建 test/ 目录结构（如果不存在）
2. 编写单元测试 → 运行 → 报告保存到 test/reports/unit/
3. 编写 UI 模拟测试脚本 → 保存到 test/scripts/
4. 运行 UI 模拟测试 → 截图保存到 test/screenshots/
5. 生成测试报告 → 保存到 test/reports/
6. 测试通过 → 通知主任务继续
7. 测试失败 → 反馈问题给主任务修复
```

#### 🟡 窗口 3：设计任务（UI/UX）
```
职责：
✅ 首先建立设计系统（Design System）- 统一风格、颜色、字体、组件
✅ 分析并统一 AI 生成的 UI 设计图（/ui 文件夹）
✅ 为缺失的 UI 设计新界面（基于设计系统保持一致性）
✅ 实现 Android/iOS/Web 界面
✅ 用户体验优化
✅ 动画效果实现
✅ 响应式布局适配

输入：
- /ui/* 文件夹中的 screen.png 和 code.html
- memory-bank/02-product-requirements.md
- task-comms/from-main.md（任务分配）

输出：
- memory-bank/07-design-system.md（设计系统文档）
- 界面实现代码
- UI 实现说明

工作流程：
┌─────────────────────────────────────────────────────────────┐
│ 阶段 1: 建立设计系统（最重要！首先做这个）                   │
├─────────────────────────────────────────────────────────────┤
│ 1. 分析所有 /ui/* 中的设计图，提取共同元素                  │
│ 2. 定义颜色规范（主色、辅色、背景色、文字色）                │
│ 3. 定义字体规范（字号、字重、行高）                          │
│ 4. 定义组件规范（按钮、输入框、卡片、导航栏等）              │
│ 5. 定义间距、圆角、阴影等装饰元素规范                        │
│ 6. 创建 memory-bank/07-design-system.md                     │
├─────────────────────────────────────────────────────────────┤
│ 阶段 2: 统一现有 UI 设计                                     │
├─────────────────────────────────────────────────────────────┤
│ 1. 对比所有 UI 设计图与设计系统                              │
│ 2. 修正不一致的地方，统一到设计系统规范                      │
│ 3. 生成 UI 实现代码                                          │
├─────────────────────────────────────────────────────────────┤
│ 阶段 3: 设计缺失的界面                                       │
├─────────────────────────────────────────────────────────────┤
│ 1. 根据产品需求确定缺失的界面列表                            │
│ 2. 基于 07-design-system.md 自行设计缺失界面                │
│ 3. 确保新界面与现有界面风格一致                              │
│ 4. 生成 UI 实现代码                                          │
└─────────────────────────────────────────────────────────────┘

处理 AI 生成 UI 不一致的策略：
  🎯 优先级：设计系统 > 单个 UI 图
  📌 当某个 UI 图与设计系统冲突时，按设计系统统一
  📌 当某个 UI 图缺少元素时，从设计系统补充
  📌 完全没有 UI 图的页面，基于设计系统自行设计
```

#### 🟣 窗口 4：文档任务（技术写作）
```
职责：
✅ API 文档编写
✅ 用户手册编写
✅ README 维护
✅ CHANGELOG 维护
✅ 代码注释完善

输入：
- memory-bank/04-architecture.md
- 功能代码和架构变更
- task-comms/from-main.md（任务分配）

输出：
- API 文档（docs/api/）
- 用户手册（docs/user-guide.md）
- README.md
- CHANGELOG.md
```

#### 🟣 窗口 5：审查任务（Code Review）
```
职责：
✅ 代码审查（Pull Request 审查）
✅ 安全漏洞扫描
✅ 性能分析和优化建议
✅ 代码质量检查
✅ 最佳实践建议

输入：
- 主任务窗口的代码提交
- task-comms/from-main.md（任务分配）

输出：
- 审查报告（task-comms/from-review.md）
- 修复建议
```

### 3. 通信协议

**主任务窗口发送任务：**
```markdown
<!-- task-comms/from-main.md -->
## 新任务
**任务 ID**: Task-001
**类型**: 开发任务
**优先级**: 高
**分配给**: 测试任务

**任务描述**:
实现用户登录功能后，需要编写测试

**输入文件**:
- 功能代码: `src/main/java/LoginActivity.kt`
- 需求文档: `memory-bank/02-product-requirements.md`

**输出要求**:
1. 编写单元测试
2. 编写 UI 模拟测试
3. 测试报告保存到 `test/reports/`

**状态**: 待处理 → 进行中 → 已完成
```

**测试任务窗口响应：**
```markdown
<!-- task-comms/from-test.md -->
## 任务响应
**任务 ID**: Task-001
**状态**: 进行中

**进度**:
- [x] 阅读代码
- [ ] 编写单元测试
- [ ] 编写 UI 模拟测试

**问题**: 发现登录逻辑有问题，请查看 `task-comms/from-test.md`
```

---

## 🚀 快速开始

### 步骤 1: 初始化多任务环境

```bash
# 在主项目目录
cd your-project

# 创建通信目录
mkdir -p task-comms

# 创建任务队列文档
# 创建 memory-bank/00-task-queue.md
```

### 步骤 2: 启动多个 Claude 窗口

```bash
# 终端 1 - 主任务
cd your-project
claude  # 或 claude-cli

# 终端 2 - 测试任务
cd your-project
claude  # 或 claude-cli

# 终端 3 - 设计任务（推荐）- 必须先启动!
cd your-project
claude
```

### 步骤 3: 为每个窗口配置角色

**窗口 3（设计任务）- 必须先启动!**
```
你: 我是设计任务窗口，负责 UI 设计工作。请：
1. 读取 task-queue.md 查看任务
2. 分析 /ui/* 文件夹中的所有设计图
3. 创建 memory-bank/07-design-system.md (设计系统)
4. 创建 memory-bank/06-ui-design.md (UI 设计文档)
5. 完成后在 task-comms/from-design.md 中通知主任务窗口
```

**窗口 1（主任务）- 等待设计完成后再启动!**
```
你: 我是主任务窗口，负责功能开发。请：
1. 等待设计窗口完成设计（查看 task-comms/from-design.md）
2. 读取 memory-bank/07-design-system.md
3. 读取 memory-bank/06-ui-design.md
4. 基于设计文档开始开发
```

**窗口 2（测试任务）- 主任务开始开发后再启动!**
```
你: 我是测试任务窗口，负责测试工作。请：
1. 等待主任务窗口通知（查看 task-comms/from-main.md）
2. 接收任务并编写测试
3. 在 task-comms/from-test.md 中报告结果
```

---

## 📋 实际使用示例

### 场景：从设计到开发到测试的完整流程

#### 第一阶段：设计（设计窗口）

**窗口 3（设计任务）：**
```
你: 我是设计任务窗口，开始进行 UI 设计工作。请：
1. 分析 /ui/* 文件夹中的所有 AI 生成的设计图
2. 创建 memory-bank/07-design-system.md
   - 提取共同的颜色、字体、组件规范
   - 统一所有不一致的设计
3. 创建 memory-bank/06-ui-design.md
   - 列出所有界面
   - 为每个界面生成实现要点
4. 在 task-comms/from-design.md 中通知主任务窗口设计完成
```

#### 第二阶段：开发（主任务窗口 - 等待设计完成）

**窗口 1（主任务）- 等待设计窗口通知:**
```
你: 我是主任务窗口，我看到 task-comms/from-design.md 显示设计已完成。
请：
1. 读取 memory-bank/07-design-system.md
2. 读取 memory-bank/06-ui-design.md
3. 选择第一个界面（如登录页面）开始实现
4. 严格按照设计系统规范实现 UI
5. 完成后在 task-comms/from-main.md 中通知测试窗口
```

#### 第三阶段：测试（测试窗口 - 等待开发完成）

**窗口 2（测试任务）- 等待主任务通知:**
```
你: 我是测试任务窗口，我看到 task-comms/from-main.md 有新任务。
请：
1. 接收任务：登录页面功能已完成
2. 读取功能代码和设计文档
3. 编写单元测试
4. 编写 UI 模拟测试（adb 控制模拟器）
5. 运行测试并生成报告
6. 在 task-comms/from-test.md 中报告结果
```

---

### 场景：开发新功能（基于已有设计系统）

**窗口 1（主任务）：**
```
你: 我要开发用户登录功能。请：
1. 先读取 memory-bank/07-design-system.md 了解设计规范
2. 再读取 memory-bank/06-ui-design.md 查看登录页面设计
3. 基于设计文档编写登录功能代码
4. 更新 00-task-queue.md，添加 Task-001
5. 在 task-comms/from-main.md 中通知测试窗口

[完成后]
你: 功能开发完成，已通知测试窗口。请在 00-task-queue.md 中更新状态。
```

**窗口 2（测试任务）：**
```
你: 我看到 task-comms/from-main.md 有新任务。
请：
1. 接收 Task-001
2. 读取登录代码
3. 编写测试
4. 运行 UI 模拟测试
5. 在 task-comms/from-test.md 中报告结果
```

---

## ⚙️ 自动化脚本

### 任务分发脚本

**`task-comms/assign-task.sh`**
```bash
#!/bin/bash
TASK_ID=$1
WINDOW=$2  # main/test/doc

echo "## 新任务分配" >> task-comms/to-${WINDOW}.md
echo "任务ID: $TASK_ID" >> task-comms/to-${WINDOW}.md
echo "时间: $(date)" >> task-comms/to-${WINDOW}.md
```

### 使用方式
```bash
./task-comms/assign-task.sh Task-001 test
```

---

## 🎯 最佳实践

### 1. 定期同步

每个窗口每完成一个任务后：
```yaml
同步操作:
  - 更新 00-task-queue.md
  - 在 task-comms/from-{role}.md 中报告状态
  - 检查 task-comms/to-{role}.md 查看新任务
```

### 2. 避免冲突

```yaml
冲突避免规则:
  - 不同窗口修改不同文件
  - 代码修改 → 主任务窗口
  - 测试代码 → 测试任务窗口
  - 文档修改 → 文档任务窗口

  如果必须修改同一文件:
  - 使用 git branch 创建功能分支
  - 完成后通过 PR 合并
```

### 3. 状态检查

每个窗口启动时检查：
```yaml
检查清单:
  - 读取 00-task-queue.md 查看任务分配
  - 读取 task-comms/from-{role}.md 查看新消息
  - 检查是否有文件冲突
```

---

## 📊 效果对比

| 单窗口 | 多窗口协同 |
|--------|------------|
| 上下文大，易丢失 | ✅ 上下文分散，稳定 |
| 串行处理 | ✅ 并行处理 |
| 难以跟踪进度 | ✅ 任务队列清晰 |
| 容易遗漏测试 | ✅ 专人负责测试 |

---

## 🔧 故障排除

### 问题：任务冲突

**解决**：使用 Git 锁机制
```bash
# 在任务开始前创建分支
git checkout -b feature/task-001
```

### 问题：消息未传递

**解决**：强制刷新
```
你: 请重新读取 task-comms/from-main.md，看看是否有新任务。
```

---

*本文档遵循 Vibe Coding 方法论 V1.2.2*
