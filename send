#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
send - Send message directly to Claude instance pane via WezTerm

Usage:
    send <instance> <message>

Examples:
    send ui "Design a login page"
    send coder "Implement this feature"
"""

import sys
import json
import subprocess
import os
from pathlib import Path

script_dir = Path(__file__).resolve().parent
project_root = script_dir.parent


def load_config():
    """Read tab mapping from .cms_config/tab_mapping.json"""
    # Read config from current working directory
    work_dir = Path.cwd()

    # Read tab mapping file
    tab_mapping_file = work_dir / ".cms_config" / "tab_mapping.json"
    if tab_mapping_file.exists():
        try:
            with open(tab_mapping_file, "r", encoding="utf-8") as f:
                mapping_data = json.load(f)
            tabs = mapping_data.get("tabs", {})
            # Extract pane_id from tabs
            result = {}
            for inst_id, tab_data in tabs.items():
                if isinstance(tab_data, dict) and "pane_id" in tab_data:
                    result[inst_id.lower()] = tab_data["pane_id"]
            if result:
                return result
        except Exception:
            pass

    # Fallback: read sequential mapping from cms.config
    config_paths = [
        work_dir / "cms.config",
        work_dir / ".cms_config" / "cms.config",
        Path.home() / ".cms" / "cms.config",
    ]

    for config_file in config_paths:
        if config_file.exists():
            try:
                with open(config_file, "r", encoding="utf-8") as f:
                    config = json.load(f)
                instances = config.get("claude", {}).get("instances", [])
                role_map = {}
                for idx, inst in enumerate(instances):
                    role_id = inst.get("id", "")
                    if role_id:
                        role_map[role_id.lower()] = str(idx)
                if role_map:
                    return role_map
            except Exception:
                continue

    return {}


def main():
    if len(sys.argv) < 3:
        print("Usage: send <instance> <message>", file=sys.stderr)
        print("Examples:", file=sys.stderr)
        print("  send c1 'continue'", file=sys.stderr)
        print("  send c2 'Implement this feature'", file=sys.stderr)
        return 1

    instance = sys.argv[1].lower()
    message = " ".join(sys.argv[2:])

    role_map = load_config()

    if not role_map:
        print("Error: Could not load instance configuration", file=sys.stderr)
        return 1

    # If instance not in mapping, but c1-c12 format, auto-infer pane_id
    if instance not in role_map:
        # Check if it's c1, c2, c3... format
        if instance.startswith("c") and instance[1:].isdigit():
            instance_num = int(instance[1:])
            if 1 <= instance_num <= 12:
                pane_id = str(instance_num - 1)  # c1 -> pane 0, c2 -> pane 1
            else:
                print(f"Error: Instance '{instance}' not found", file=sys.stderr)
                return 1
        else:
            print(f"Error: Instance '{instance}' not found", file=sys.stderr)
            return 1
    else:
        pane_id = role_map[instance]

    try:
        # Send message (in two steps: send message first, then send enter)
        subprocess.run(
            [
                "wezterm",
                "cli",
                "send-text",
                "--pane-id",
                pane_id,
                "--no-paste",
                message,
            ],
            check=True,
            capture_output=True,
        )
        # Send enter
        subprocess.run(
            ["wezterm", "cli", "send-text", "--pane-id", pane_id, "--no-paste"],
            input=b"\r",
            check=True,
            capture_output=True,
        )
        print(f"âœ“ Sent to {instance} (pane {pane_id})")
        return 0
    except subprocess.CalledProcessError:
        print(f"Error: Failed to send to pane {pane_id}", file=sys.stderr)
        print(
            f"Hint: Please run 'python run.py' to start instances first",
            file=sys.stderr,
        )
        return 1
    except FileNotFoundError:
        print(
            f"Error: wezterm command not found, please ensure WezTerm is installed",
            file=sys.stderr,
        )
        return 1
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main())
